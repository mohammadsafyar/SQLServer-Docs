<div dir="rtl">
# مقاله: مقایسه Row Mode Execution، Batch Mode Execution و Parallel Execution در SQL Server

در این مقاله به بررسی سه روش پردازش پرس‌وجو در SQL Server می‌پردازیم:

</div dir="rtl">

- Row Mode Execution
- Batch Mode Execution
- Parallel Execution

---
<div dir="rtl">
  
## 1. Row Mode Execution چیست؟

### تعریف

Row Mode Execution روش سنتی پردازش پرس‌وجوها در SQL Server است که در آن هر ردیف به‌صورت جداگانه و مستقل پردازش می‌شود. این روش به‌صورت پیش‌فرض برای اکثر پرس‌وجوها استفاده می‌شود، مگر اینکه SQL Server تشخیص دهد روش دیگری کارایی بهتری دارد.

### نحوه کار

- پردازش ردیف‌به‌ردیف: هر هسته پردازشی (CPU Core) در هر لحظه فقط یک ردیف را پردازش می‌کند و پس از اتمام، به سراغ ردیف بعدی می‌رود.
- پاراللیسم (Parallelism): اگر از چندین هسته استفاده شود، داده‌ها بین هسته‌ها تقسیم می‌شوند و هر هسته به‌صورت موازی ردیف‌های خود را پردازش می‌کند. مثلاً اگر جدولی با ۵۰ میلیون ردیف داشته باشیم:

  - هسته ۱: ردیف‌های ۱ تا ۲۵ میلیون
  - هسته ۲: ردیف‌های ۲۵,۰۰۰,۰۰۱ تا ۵۰ میلیون
- تقسیم داده‌ها: SQL Server سعی می‌کند داده‌ها را به‌طور مساوی بین هسته‌ها تقسیم کند، اما این تقسیم همیشه ۱۰۰٪ برابر نیست و به عواملی مثل بهینه‌سازی مبتنی بر هزینه (Cost-Based Optimization)، عدم توازن داده‌ها (Data Skew) و در دسترس بودن منابع بستگی دارد.

### مزایا

- سادگی اجرا برای پرس‌وجوهای کوچک
- مناسب برای جداول با حجم کم یا پرس‌وجوهای ساده

### معایب

- Overhead: به دلیل پردازش جداگانه هر ردیف و وجود Context Switch بین مراحل، مقداری سربار (Overhead) ایجاد می‌شود
- کندتر بودن در پرس‌وجوهای پیچیده یا جداول بزرگ

### کنترل و بررسی

- می‌توانید با استفاده از MAXDOP (Maximum Degree of Parallelism) تعداد هسته‌های درگیر را محدود کنید
- از DMVها (مانند sys.dm_exec_requests) برای بررسی توزیع کار بین هسته‌ها استفاده کنید
</div dir="rtl">
---
<div dir="rtl">
  
## 2. Batch Mode Execution چیست؟

### تعریف

Batch Mode Execution روش پیشرفته‌تری برای پردازش پرس‌وجوهاست که به جای پردازش تک‌تک ردیف‌ها، داده‌ها را در دسته‌های کوچک‌تر (Batch) پردازش می‌کند. این روش معمولاً با ایندکس‌های ستونی (Columnstore Indexes) استفاده می‌شود و از SQL Server 2019 به بعد در برخی موارد روی جداول ردیفی (Rowstore) نیز قابل‌اجراست.

### نحوه کار

- دسته‌بندی داده‌ها: داده‌ها به گروه‌هایی بین ۶۴ تا ۹۰۰ ردیف (بسته به بهینه‌سازی SQL Server) تقسیم می‌شوند
- پردازش برداری (Vectorized): عملیات (مثل جمع، فیلتر یا Join) به‌صورت همزمان روی کل دسته انجام می‌شود، نه روی تک‌تک ردیف‌ها
- ارتباط با Columnstore: این روش برای ایندکس‌های ستونی بهینه شده است، زیرا داده‌ها به‌صورت ستون‌محور و فشرده ذخیره شده‌اند و پردازش دسته‌ای روی آن‌ها سریع‌تر است

### مثال ساده

فرض کنید می‌خواهید جمع ستون "قیمت" را در جدولی با ۱ میلیون ردیف محاسبه کنید:

- Row Mode: SQL Server تک‌تک ۱ میلیون ردیف را می‌خواند و جمع می‌کند
- Batch Mode: داده‌ها به دسته‌های ۱۰۰۰ تایی تقسیم شده و جمع هر دسته به‌صورت همزمان محاسبه می‌شود

### مزایا

- سرعت بالاتر: عملکرد پرس‌وجوها معمولاً ۲ تا ۴ برابر بهتر می‌شود (در برخی موارد حتی بیشتر)
- مصرف بهینه منابع: استفاده بهتری از CPU و حافظه می‌شود
- مناسب برای تحلیل داده: ایده‌آل برای پرس‌وجوهای پیچیده مثل جمع، میانگین یا فیلتر روی داده‌های بزرگ
- بهینه‌سازی حافظه: کاهش نیاز به Memory Grant و فشرده‌سازی تا ۱۰ برابر
- بهره‌وری CPU: کاهش زمان پردازش تا ۵۰٪ در برخی سناریوها

### چرا با Columnstore جفت و جور است؟

- ساختار ستونی: فقط ستون‌های موردنیاز خوانده می‌شوند
- فشرده‌سازی: داده‌ها در حافظه جا می‌گیرند و پردازش سریع‌تر است
- دستورات SIMD: از قابلیت‌های CPU برای پردازش همزمان چند داده استفاده می‌کند

### محدودیت‌ها

- وابستگی به Columnstore در نسخه‌های قدیمی‌تر (قبل از ۲۰۱۹)
- عدم کارایی در پرس‌وجوهای خیلی ساده (مثل SELECT تک‌ردیفی)
- نیاز به سخت‌افزار قوی (CPU و RAM کافی)

### تشخیص استفاده

در Execution Plan (قابل‌مشاهده در SSMS)، عباراتی مثل "Batch Mode Scan" یا "Batch Mode Hash Join" نشان‌دهنده استفاده از این روش هستند.

---

## 3. Parallel Execution چیست؟

### تعریف

Parallel Execution زمانی رخ می‌دهد که SQL Server یک پرس‌وجو را به چند بخش تقسیم کرده و هر بخش را با یک Thread جداگانه روی هسته‌های مختلف CPU اجرا می‌کند. هدف این روش، کاهش زمان کلی اجرا با استفاده از چندین هسته است.

### نحوه کار

- تقسیم داده‌ها: جدول به بخش‌هایی تقسیم می‌شود و هر بخش به یک هسته اختصاص می‌یابد
- اجرای موازی: هر هسته به‌صورت مستقل روی بخش خود کار می‌کند
- مثال: برای فیلتر کردن یک جدول بزرگ، SQL Server ممکن است آن را به ۴ بخش تقسیم کند و هر بخش را با یک هسته جداگانه پردازش کند

### تفاوت با Row Mode و Batch Mode

- در Row Mode با Parallelism، هر هسته همچنان ردیف‌به‌ردیف پردازش می‌کند، اما روی بخش‌های مختلف داده
- در Batch Mode با Parallelism، هر هسته دسته‌های داده را پردازش می‌کند که کارایی بیشتری دارد

### مزایا

- کاهش زمان اجرا در پرس‌وجوهای سنگین
- استفاده بهینه از چند هسته CPU

### معایب

- پیچیدگی بیشتر در مدیریت منابع
- احتمال عدم توازن در تقسیم داده‌ها (Data Skew)

---

## مقایسه Row Mode و Batch Mode

| ویژگی             | Row Mode Execution         | Batch Mode Execution         |

|-------------------|----------------------------|------------------------------|

| واحد پردازش      | تک‌تک ردیف‌ها             | دسته‌های کوچک (۶۴-۹۰۰ ردیف) |

| سرعت             | کندتر در داده‌های بزرگ   | ۲-۴ برابر سریع‌تر           |

| مصرف منابع        | Overhead بیشتر            | بهینه‌تر                    |

| ارتباط با ایندکس | مستقل از نوع ایندکس       | بهینه برای Columnstore      |

| کاربرد           | پرس‌وجوهای کوچک و ساده   | تحلیل داده‌های بزرگ و پیچیده |

---

## پاسخ به سؤالات کلیدی

### 1. آیا در Row Mode هر هسته ۲۵ میلیون رکورد را یکی‌یکی پردازش می‌کند؟

بله، در Row Mode هر هسته یک رکورد را در لحظه پردازش می‌کند و به ترتیب پیش می‌رود. مثلاً:

- هسته ۱: رکورد ۱ تا ۲۵ میلیون
- هسته ۲: رکورد ۲۵,۰۰۰,۰۰۱ تا ۵۰ میلیون

### 2. آیا تقسیم رکوردها بین هسته‌ها برابر است؟

معمولاً بله، اما نه همیشه:

- عوامل تأثیرگذار: بهینه‌سازی مبتنی بر هزینه، عدم توازن داده‌ها (Skewed Data)، و در دسترس بودن CPU و حافظه
- تلاش SQL Server: داده‌ها را تا حد ممکن مساوی تقسیم می‌کند، اما در صورت پیچیدگی داده‌ها ممکن است برخی هسته‌ها بیشتر یا کمتر کار کنند

---
<div dir="rtl">
## جمع‌بندی

- Row Mode Execution: مناسب برای پرس‌وجوهای ساده، اما در داده‌های بزرگ کندتر است
- Batch Mode Execution: بهینه برای تحلیل داده‌های بزرگ با ایندکس‌های ستونی، سریع‌تر و کم‌مصرف‌تر
- Parallel Execution: استفاده از چند هسته برای کاهش زمان اجرا، قابل ترکیب با هر دو روش بالا
</div dir="rtl">
برای بهینه‌سازی عملکرد:

- از MAXDOP و Resource Governor برای کنترل پردازش موازی استفاده کنید
- ایندکس‌های Columnstore و Batch Mode را برای انبار داده‌ها (Data Warehouse) و سیستم‌های OLAP در نظر بگیرید
- پلن اجرایی را بررسی کنید تا مطمئن شوید SQL Server بهترین روش را انتخاب کرده است

این سه روش مکمل یکدیگرند و انتخاب درست آن‌ها به نوع پرس‌وجو، حجم داده و سخت‌افزار بستگی دارد.
